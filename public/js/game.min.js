var player,
	remotePlayers;

var Player = function(id, username) {
	this.id = id;
	this.username = username;
	this.team = "";
	this.entity = null;
};

player = new Player();

/* **********************************************
     Begin eventHandlers.js
********************************************** */

/* global Game:true, Crafty, io, Player, player, remotePlayers */

var socket;

// Socket connected
function onSocketConnected() {
	console.log("Connected to socket server");
}

// Socket disconnected
function onSocketDisconnect() {
	console.log("Disconnected from socket server");
}

function addToWaitingRoom(player, cssClass) {
	$('#waiting-room li#player-' + player.id).remove();

	var listItem = "";
	listItem += '<li id="player-' + player.id + '"' + (cssClass ? ' class="'+cssClass+'"' : "") + '>';
	listItem += player.username;
	listItem += '</li>';

	$('#waiting-room ul#team-'+player.team).append(listItem);
}

// New player
function onNewPlayer(data) {

	// Initialise the new player
	console.log("New player connected: " + data.id);
	var newPlayer = new Player(data.id, data.name);

	if(data.team) {
		newPlayer.team = data.team;
		addToWaitingRoom(newPlayer);
	}

	// Add new player to the remote players array
	remotePlayers[data.id] = newPlayer;
}

// Remove player
function onRemovePlayer(data) {
	var player = remotePlayers[data.id];

	// Player not found
	if (!player) {
		console.log("Player not found: "+data.id);
		return;
	}

	// remove player from waiting room
	$('#waiting-room li#player-' + player.id).remove();

	// Remove player from array
	delete remotePlayers[data.id];
}

function onIdAssignment(data) {
	console.log("Assigning player to ID " + data.id);
	player.id = data.id;
}

function onTeamAssignment(data) {

	var player = remotePlayers[data.id];

	// Player not found
	if (!player) {
		console.log("Player not found: "+data.id);
		return;
	}

	player.team = data.team;
	console.log(player.username + " assigned to: " + player.team);

	// add player to waiting room
	addToWaitingRoom(player);

}

function onWaitingMessage(data) {
	$('#waiting-room #waiting-msg').text(data);
}

function onStartGame(data) {
	console.log("Starting game!");
	Crafty.scene('Game');
}

function onGameInProgress(data) {
	Crafty.scene('GameInProgress');
}

function addChatMsg(msg, username) {
	var chatBox = $('#chat-msgs');
	chatBox.append("<br />" + username + ": " + msg);
	chatBox.scrollTop(chatBox.get(0).scrollHeight);
}

function onChatMsg(data) {
	addChatMsg(data.msg, data.username);
}

function onMove(data) {
	var player = remotePlayers[data.id];
	player.entity.x = data.x;
	player.entity.y = data.y;
}

function setEventHandlers() {

	// Socket connection successful
	socket.on("connect", onSocketConnected);

	// Socket disconnection
	socket.on("disconnect", onSocketDisconnect);

	// New player message received
	socket.on("new player", onNewPlayer);

	// Player removed message received
	socket.on("remove player", onRemovePlayer);

	// ID assignment
	socket.on("id assignment", onIdAssignment);

	// Team assignment
	socket.on("team assignment", onTeamAssignment);

	// Waiting message update
	socket.on("waiting msg", onWaitingMessage);

	// Game start!
	socket.on("start game", onStartGame);

	// Game in progress
	socket.on("game in progress", onGameInProgress);

	// Chat messages
	socket.on("chat msg", onChatMsg);

	// Player movements
	socket.on("move", onMove);

}

/* **********************************************
     Begin game.js
********************************************** */

/* global Game:true, Crafty, io, socket:true, Player, player, remotePlayers:true */

//@codekit-prepend 'Player.js', 'eventHandlers.js'
//@codekit-append 'components.js', 'scenes.js'

Game = {

	map_grid : {
		width:  32,
		height: 32,
		tile: {
			width:  16,
			height: 16
		}
	},

	start: function() {

		Crafty.init(480, 320);
		Crafty.viewport.init(480, 320);
		Crafty.background('black');
		Crafty.scene('Start');

		// Initialise socket connection
		socket = io.connect("http://localhost", {port: 8000, transports: ["websocket"]});

		// Initialise remote players array
		remotePlayers = {};

		// clear list items from previous game
		$('#waiting-room li').remove();

		// Start listening for events
		setEventHandlers();

	}

};

$(document).ready(function() {
	Game.start();
});

/* **********************************************
     Begin components.js
********************************************** */

/* global Game:true, Crafty, io, socket:true, Player, player, remotePlayers:true */

Crafty.c('Grid', {

	init: function() {
		this.attr({
			w: Game.map_grid.tile.width,
			h: Game.map_grid.tile.height
		});
	},

	// Locate this entity at the given position on the grid
	at: function(x, y) {
		if (x === undefined && y === undefined) {
			return {
				x: this.x/Game.map_grid.tile.width,
				y: this.y/Game.map_grid.tile.height
			};
		} else {
			this.attr({
				x: x * Game.map_grid.tile.width,
				y: y * Game.map_grid.tile.height
			});
			return this;
		}
	}
});

Crafty.c('Stage', {
	init: function() {
		this.requires('2D, Canvas, Color, Grid')
			.color('green')
			.attr({
				w: Game.map_grid.tile.width * Game.map_grid.width,
				h: Game.map_grid.tile.height * Game.map_grid.height
			});
	}
});

Crafty.c('Actor', {
	init: function() {
		this.requires('2D, Canvas');
	}
});

Crafty.c('Edge', {
	init: function() {
		this.requires('Actor, Solid, Color, Grid, Solid')
			.color('black');
	},
});

Crafty.c('Player', {

	init: function() {
		this.requires('Actor, Color, Grid')
			.color('rgb(20,75,40)');
	}

});

Crafty.c('PlayerCharacter', {

	init: function() {
		this.requires('Player, Multiway, Collision')
			.multiway(4, {UP_ARROW: -90, DOWN_ARROW: 90, RIGHT_ARROW: 0, LEFT_ARROW: 180})
			.color('rgb(20,75,40)')
			.postMovement()
			.stopOnSolids()
			.disableOnChat();
	},

	postMovement: function() {

		this.bind('Moved', function() {
			socket.emit("move", {x: this.x , y: this.y});
		});

		return this;

	},

	stopOnSolids: function() {
		this.onHit('Solid', this.stopMovement);
		return this;
	},

	stopMovement: function() {

		this._speed = 0;
		if (this._movement) {
			this.x -= this._movement.x;
			this.y -= this._movement.y;
		}

		return this;

	},

	disableOnChat: function() {

		var pc = this;

		$('input#chatMsg').focus(function() {
			pc.disableControl();
		});

		$('input#chatMsg').blur(function() {
			pc.enableControl();
		});

		return this;

	}

});

/* **********************************************
     Begin scenes.js
********************************************** */

/* global Game:true, Crafty, io, socket:true, Player, player:true, remotePlayers:true, addChatMsg, _, addToWaitingRoom */

Crafty.scene('Start', function() {

	$('.custom-scene').hide();
	$('#start').show();

	$('#start input[type=submit]').click(function(e) {

		e.preventDefault();

		var username = encodeURI($('input#username').val().trim());
		socket.emit("new player", {name: username});

		player.username = username;

		Crafty.scene('WaitingRoom');

	});

});

Crafty.scene('WaitingRoom', function() {

	$('.custom-scene').hide();
	$('#waiting-room').show();

	// when user selects a team
	$('#waiting-room input[type=submit]').click(function(e) {

		e.preventDefault();

		// post team selection to server
		var selectedTeam = $(this).attr('id');
		socket.emit("team assignment", {team: selectedTeam});

		// add player to the selected team
		player.team = selectedTeam;
		addToWaitingRoom(player, 'self');

	});

});

Crafty.scene('GameInProgress', function() {
	$('.custom-scene').hide();
	$('#game-in-progress').show();
});

Crafty.scene('Game', function() {

	$('.custom-scene').hide();
	$('#below-game').show();

	Crafty.map.insert(Crafty.e('Stage').at(0,0));

	for (var x = 0; x < Game.map_grid.width; x++) {
		for (var y = 0; y < Game.map_grid.height; y++) {
			var at_edge = x === 0 || x === Game.map_grid.width - 1 || y === 0 || y === Game.map_grid.height - 1;
			if (at_edge) {
				Crafty.e('Edge').at(x, y);
			}
		}
	}

	// add teammates to free list
	var freeTeammates = $('#free-teammates ul');
	_.each(remotePlayers, function(thisPlayer) {
		if(thisPlayer.team === player.team) {
			freeTeammates.append('<li id="player-' + thisPlayer.id + '">' + thisPlayer.username + '</li>');
		}
	});

	// initialize player positions
	var initPlayer;
	socket.on("init player", function(data) {

		// player character
		if(data.id === player.id) {
			player.entity = Crafty.e('PlayerCharacter').at(data.x, data.y);
			Crafty.viewport.follow(player.entity, 20, 20);
		}

		else {
			initPlayer = remotePlayers[data.id];
			initPlayer.entity = Crafty.e('Player').at(data.x, data.y);
		}

	});

	// chat message submitted
	$('form#chatForm').submit(function(e) {

		e.preventDefault();

		// get chat message
		var chatMsg = $('input#chatMsg').val();

		// add chat message to chat box
		$('input#chatMsg').val("");
		addChatMsg(chatMsg, player.username);

		// post chat message to server
		socket.emit("chat msg", chatMsg);

	});

});